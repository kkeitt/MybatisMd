#### CORS

CORS是一个W3C标准，全称是：跨域资源共享（Cross-origin resource sharing）

它允许浏览器向跨源服务器，发出Ajax请求，解决了Ajax只能同源使用的问题。

浏览器将CORS请求分为两类：**简单请求**和**非简单请求**

#### 简单请求

满足以下条件的即为简单请求

- 请求方法是GET,POST,HEAD中的任意一个
- 请求头自定义字段必须在下列集合中
  **Accept,Accept-Language,Content-Language,Content-Type,DPR,Downlink,Save-Data,Viewport-Width,Width**
- 如果请求头使用了Content-Type字段，则字段的值必须是以下三个值中的任意一个
  **text/plain,multipart/form-data,application/x-www-form-urlencoded**

对于简单请求，浏览器直接发出跨域请求，在请求头中加入**Origin**字段，这个字段用于说明请求来自哪个源（协议+域名+端口）。

![1548338971792](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548338971792.png)

服务器根据这个值，决定是否接受请求，如果Origin的值不在许可范围内，服务器会返回正常的响应，但是浏览器发现响应头中并没有Access-Control-Allow-Origin字段，然后会抛出一个错误，这种错误是无法通过状态码确定的，因为状态码有可能是200。

如果Origin的值在接受范围内，就会多返回几个字段，如下图

![1548339008352](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548339008352.png)

3. #### 非简单请求

   ##### 预检查

   对于非简单请求，在发送跨域请求时，浏览器会自动发出一个**OPTIONS**请求来检测本次请求是否被服务器接受，以及可以使用哪些HTTP请求方法，头信息字段。

   OPTIONS请求一般会携带以下两个请求头

   - Access-Control-Allow-Request-Method：本次预检请求的请求方法
   - Access-Control-Allow-Request-Headers：本次预检请求携带的自定义首部字段，这些字段是产生预检请求的一个原因。

   服务器在收到预检请求后，会返回跨域相关的响应头，主要包括以下三个

   - Access-Control-Allow-Origin：服务器允许的跨域请求源
   - Access-Control-Allow-Methods：服务器允许的跨域请求方法
   - Access-Control-Allow-Headers：服务器允许的自定义请求首部字段

   ![1548337754951](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548337754951.png)

   

   其它的字段如：**Access-Control-Expose-Headers**，**Access-Control-Allow-Credentials**，**Access-Control-Max-Age**

   1.Access-Control-Expose-Headers：在跨域请求中，XMLHttpReqeust对象的getResponseHeader方法只能获取到6个基本字段

   - Cache-Control
   - Content-Language
   - Content-Type
   - Expires
   - Last-Modified
   - Pragma

   如果要拿到其他响应头，必须在Access-Control-Expose-Headers中指定。

   例如：加入如下响应头

   ```java
   rep.addHeader("customer-header","hello i'm a custom header");
   ```

   设置Access-Control-Expose-Headers属性

   ```java
   rep.addHeader("Access-Control-Expose-Headers","customer-header");
   ```

   Ajax请求

   ```javascript
   function send() {
               $.ajax({
                   url:'http://127.0.0.1:8080/test/get',
                   type:'get',
                   success:function (res,status,xhr) {
                       console.log(xhr.getResponseHeader("customer-header"));
                   }
               })
           }
   ```

   结果：

   ![1548772165330](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548772165330.png)

   2.Access-Control-Allow-Credentials：是否允许携带cookie，详见cookie跨域。

   3.Access-Control-Max-Age：预检请求的有效期，单位是秒，在此时间内，会缓存第一次预检请求，不会产生新的预检请求。

   预检请求只是一个检查的过程，请求没有任何参数，检查通过之后才会发送真正的请求。

   如果服务器没有对请求做响应，浏览器不会发出真正的请求。检查不通过也不会发出请求，并且会在控制台报错或警告（浏览器不同，方式不一样）。

   ![1548337917463](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548337917463.png)

##### cookie跨域

默认情况下，cookie是不包含在跨域请求中的，如果要在跨域请求中传递cookie，需要同时在前后台进行设置

1. 前台需要在ajax请求中加入**xhrFields**配置，配置**withCredentials**属性为true

```javascript
$.ajax({
    url:'http://127.0.0.1:8080/test/get',
    type:'get',
    xhrFields:{
    	withCredentials:true
    },
    success:function (res) {
    	console.log(res);
    }
 })
```

有些浏览器在没有配置的情况下也会发送cookie，这时可以手动关闭withCredentitals

```javascript
xhr.withCredentials = false;
```

1. 后台需要在响应头中加入**Access-Control-Allow-Credentials**，值为**true**

```java
rep.addHeader("Access-Control-Allow-Credentials","true");
```

设为true，表示服务器允许允许发送cookie，如果没有设置这个响应头，浏览器会报错，提示响应头中的Access-Control-Allow-Credentials的值为'',必须为true才可以发送。

![1548430326407](C:\Users\92051\AppData\Roaming\Typora\typora-user-images\1548430326407.png)

1. 后台响应头中的**Access-Control-Allow-Origin**的值不能为*，必须指定明确的值，这时可以通过动态获取请求头中的Origin属性，动态调整Access-Control-Allow-Origin的值，实现\*的效果

   ```java
   String origin = req.getHeader("Origin");
   rep.addHeader("Access-Control-Allow-Origin",origin);
   ```

   #### 